<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalyna Updates 排序编辑器（拖拽排序 / 置顶 / 导出）</title>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--muted:#74829a;--fg:#e6edf3;--acc:#4cc2ff;--border:#1f2a3a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0f14,#0b0f14cc 60%,#0b0f1400);backdrop-filter: blur(6px);z-index:5;border-bottom:1px solid var(--border)}
    header .wrap{max-width:1100px;margin:auto;padding:12px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0;font-weight:700}
    .muted{color:var(--muted)}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:12px 0}
    .toolbar input[type="text"], .toolbar input[type="number"], .toolbar select{
      background:#0e131b;border:1px solid var(--border);color:var(--fg);padding:8px 10px;border-radius:10px;outline:none
    }
    .toolbar button{background:#0e131b;border:1px solid var(--border);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .toolbar button.primary{background:var(--acc);color:#00223a;border-color:#59c9ff;font-weight:700}
    .toolbar button:disabled{opacity:.6;cursor:not-allowed}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:980px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.cards{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:140px}
    .drag-handle{cursor:grab;user-select:none;background:#0e131b;color:var(--muted);font-size:12px;padding:6px 10px;border-bottom:1px dashed var(--border);display:flex;justify-content:space-between;align-items:center}
    .drag-handle .id{opacity:.7;max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .body{padding:10px 12px;display:flex;gap:10px}
    .cover{width:72px;height:72px;border-radius:10px;border:1px solid var(--border);object-fit:cover;background:#0e131b}
    .meta{flex:1;min-width:0}
    .title{font-weight:700;margin:2px 0 6px 0;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .note{font-size:12px;color:var(--muted)}
    .tags{margin-top:6px;font-size:12px;color:#8fb3ff}
    .actions{display:flex;gap:6px;margin-top:8px}
    .actions button{padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:#0e131b;color:var(--fg);font-size:12px}
    .pinned{outline:2px solid #ffd166}
    .ghost{opacity:.4;border-style:dashed}
    .footer{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:16px;color:var(--muted)}
    .status{font-size:12px}
    .pill{background:#0e131b;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0e131b;border:1px solid var(--border);border-radius:6px;padding:1px 5px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Kalyna Updates 排序编辑器</h1>
      <div class="muted">拖拽排序、置顶、搜索；导出为新的 <span class="kbd">updates-all.json</span></div>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <button id="btnLoad" class="primary">从 /data/updates-all.json 载入</button>
      <input type="file" id="filePick" accept="application/json" />
      <input id="search" type="text" placeholder="搜索标题/摘要/标签…" />
      <select id="platform">
        <option value="">全部平台</option>
      </select>
      <button id="btnReset">清空筛选</button>
      <span class="pill" id="count">0 条</span>
      <span style="flex:1"></span>
      <button id="btnPinTop">把选中置顶</button>
      <button id="btnUnpin">取消置顶</button>
      <button id="btnExport" class="primary">导出为 updates-all.json</button>
    </div>

    <div id="grid" class="cards" aria-live="polite"></div>

    <div class="footer">
      <div class="status" id="status">未加载</div>
      <div class="muted">提示：按住卡片上方的“≡ 拖拽把手”进行排序；导出后把 JSON 提交到仓库。</div>
    </div>
  </main>

  <script>
    // ------- State -------
    let all = [];          // 原始数据（全量）
    let view = [];         // 视图数据（筛选后、可排序）
    let selection = new Set(); // 被选中项 id

    // ------- Utils -------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const esc = s => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const byId = () => Object.fromEntries(all.map(x => [x.id || x.url || x.title, x]));

    function normalizeItem(x){
      const id = String(x.id || x.url || x.title || Math.random().toString(36).slice(2));
      return {
        ...x,
        id,
        title: String(x.title || '').trim(),
        date: String(x.date || '').slice(0,10),
        dateTime: String(x.dateTime || ''),
        ts: typeof x.ts === 'number' ? x.ts : 0,
        platform: String(x.platform || ''),
        url: String(x.url || ''),
        image: String(x.image || ''),
        excerpt: String(x.excerpt || ''),
        tags: Array.isArray(x.tags) ? x.tags : [],
        pinned: !!x.pinned,
        rank: (typeof x.rank === 'number' && isFinite(x.rank)) ? x.rank : null,
        tsOverride: (typeof x.tsOverride === 'number' && isFinite(x.tsOverride)) ? x.tsOverride : null
      };
    }

    function sortWithManual(arr){
      return arr.sort((a,b)=>{
        const pa = a.pinned ? 1 : 0; const pb = b.pinned ? 1 : 0; if (pb-pa) return pb-pa;
        const ra = (typeof a.rank === 'number') ? a.rank : null; const rb = (typeof b.rank === 'number') ? b.rank : null;
        if (ra!==null || rb!==null){ if (ra===null) return 1; if (rb===null) return -1; if (ra!==rb) return ra-rb; }
        const ta = a.tsOverride || a.ts || 0; const tb = b.tsOverride || b.ts || 0; if (tb-ta) return tb-ta;
        const dc = (b.date||'').localeCompare(a.date||''); if (dc) return dc;
        return (b.title||'').localeCompare(a.title||'');
      });
    }

    function applyFilter(){
      const q = $('#search').value.trim().toLowerCase();
      const plat = $('#platform').value;
      view = all.filter(it=>{
        if (plat && String(it.platform)!==plat) return false;
        if (!q) return true;
        const hay = [it.title||'', it.excerpt||'', ...(Array.isArray(it.tags)?it.tags:[])].join(' ').toLowerCase();
        return q.split(/\s+/).every(w=>w && hay.includes(w));
      });
      sortWithManual(view);
      $('#count').textContent = view.length + ' 条';
      render();
    }

    function render(){
      const grid = $('#grid');
      grid.innerHTML = '';
      const lookup = byId();
      for (const it of view){
        const card = document.createElement('article');
        card.className = 'card' + (it.pinned ? ' pinned':'' );
        card.dataset.id = it.id;

        // Drag handle
        const handle = document.createElement('div');
        handle.className = 'drag-handle';
        handle.draggable = true;
        handle.innerHTML = `<span>≡ 拖拽</span><span class="id">${esc(it.id)}</span>`;
        handle.addEventListener('dragstart', onDragStart);
        handle.addEventListener('dragend', onDragEnd);
        card.appendChild(handle);

        const body = document.createElement('div');
        body.className = 'body';
        body.innerHTML = `
          ${it.image ? `<img class="cover" src="${esc(it.image)}" alt="">` : `<div class="cover"></div>`}
          <div class="meta">
            <div class="title">${esc(it.title||'(无标题)')}</div>
            <div class="note">${esc(it.date||'—')} · ${esc(it.platform||'RSS')} · <a href="${esc(it.url)}" target="_blank" rel="noopener">原文 ↗</a></div>
            ${Array.isArray(it.tags) && it.tags.length ? `<div class="tags">#${it.tags.map(esc).join(' #')}</div>` : ''}
            <div class="actions">
              <button data-act="pin">${it.pinned?'取消置顶':'置顶'}</button>
              <button data-act="rank">设定序号</button>
              <button data-act="pick">选中/取消</button>
            </div>
          </div>`;
        body.addEventListener('click', onActionClick);
        card.appendChild(body);

        grid.appendChild(card);
      }
      $('#status').textContent = '可拖拽排序：拖动卡片上方的“≡”';
    }

    // ------- Drag & Drop -------
    let dragId = null;
    function onDragStart(e){
      const card = e.target.closest('.card');
      dragId = card?.dataset.id || null;
      e.dataTransfer?.setData('text/plain', dragId);
      e.dataTransfer?.setDragImage(card, 20, 20);
      requestAnimationFrame(()=> card.classList.add('ghost'));
      $('#grid').addEventListener('dragover', onDragOver);
      $('#grid').addEventListener('drop', onDrop);
    }
    function onDragEnd(e){
      $$('.card.ghost').forEach(n=>n.classList.remove('ghost'));
      $('#grid').removeEventListener('dragover', onDragOver);
      $('#grid').removeEventListener('drop', onDrop);
    }
    function onDragOver(e){
      e.preventDefault();
      const grid = $('#grid');
      const after = getDragAfterElement(grid, e.clientY);
      const dragging = $(`.card[data-id="${CSS.escape(dragId)}"]`);
      if (!dragging) return;
      if (after == null) grid.appendChild(dragging); else grid.insertBefore(dragging, after);
    }
    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.card:not(.ghost)')];
      return els.find(el => {
        const rect = el.getBoundingClientRect();
        return y < rect.top + rect.height / 2;
      }) || null;
    }
    function onDrop(e){
      e.preventDefault();
      // 根据当前 DOM 顺序更新 view 与 all 的 rank
      const ids = $$('.card').map(n=>n.dataset.id);
      const index = new Map(ids.map((id,i)=>[id,i]));
      view.sort((a,b)=> index.get(a.id) - index.get(b.id));
      // 把 view 的顺序同步回 all（仅改变 rank）
      // 规则：当前视图顺序 -> rank: 1..N，未在视图中的项 rank 不动
      let r = 1;
      const present = new Set(ids);
      for (const it of all){ if (present.has(it.id)) it.rank = r++; }
      applyFilter();
    }

    // ------- Card actions -------
    function onActionClick(e){
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const card = e.target.closest('.card');
      const id = card?.dataset.id;
      const item = all.find(x=>x.id===id);
      if (!item) return;
      const act = btn.dataset.act;
      if (act==='pin'){
        item.pinned = !item.pinned;
        applyFilter();
      } else if (act==='rank'){
        const input = prompt('设置序号（数字越小越靠前，留空取消自定义顺序）', item.rank??'');
        if (input===null) return;
        const v = String(input).trim();
        if (v==='') item.rank = null; else {
          const n = Number(v); if (Number.isFinite(n)) item.rank = n;
        }
        applyFilter();
      } else if (act==='pick'){
        if (selection.has(id)) selection.delete(id); else selection.add(id);
        card.classList.toggle('picked');
      }
    }

    // ------- Toolbar actions -------
    $('#btnLoad').addEventListener('click', async ()=>{
      try{
        const url = '../data/updates-all.json?ts=' + Date.now();
        const res = await fetch(url,{cache:'no-store'});
        if (!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        loadData(json);
        $('#status').textContent = '已从 /data/updates-all.json 载入';
      }catch(err){
        alert('加载失败：'+err.message+'\n你也可以点击左侧文件选择器，手动选择本地 updates-all.json');
      }
    });

    $('#filePick').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try{
        const text = await f.text();
        const json = JSON.parse(text);
        loadData(json);
        $('#status').textContent = '已从本地文件载入：'+f.name;
      }catch(err){
        alert('解析失败：'+err.message);
      }
    });

    $('#btnReset').addEventListener('click', ()=>{
      $('#search').value='';
      $('#platform').value='';
      applyFilter();
    });

    $('#search').addEventListener('input', ()=>{
      applyFilter();
    });

    $('#btnPinTop').addEventListener('click', ()=>{
      if (!selection.size){ alert('请先用“选中/取消”按钮选择卡片'); return; }
      for (const id of selection){ const it = all.find(x=>x.id===id); if (it) it.pinned = true; }
      applyFilter();
    });
    $('#btnUnpin').addEventListener('click', ()=>{
      if (!selection.size){ alert('请先用“选中/取消”按钮选择卡片'); return; }
      for (const id of selection){ const it = all.find(x=>x.id===id); if (it) it.pinned = false; }
      applyFilter();
    });

    $('#btnExport').addEventListener('click', ()=>{
      // 导出策略：
      // 1) 依据当前筛选后的可见顺序，为这些项设置 rank=1..N；未可见的项保留原 rank
      const ids = $$('.card').map(n=>n.dataset.id);
      let r = 1; const set = new Set(ids);
      for (const it of all){ if (set.has(it.id)) it.rank = r++; }

      // 2) 按手动规则整体排序，确保导出的顺序 = 你看到的顺序
      const exporting = sortWithManual(all.slice());

      // 3) 触发下载
      const blob = new Blob([JSON.stringify(exporting, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'updates-all.json';
      a.click();
      URL.revokeObjectURL(a.href);

      $('#status').textContent = '已导出 updates-all.json（请提交到仓库覆盖原文件）';
    });

    function loadData(json){
      if (!Array.isArray(json)) throw new Error('JSON 不是数组');
      all = json.map(normalizeItem);
      // 平台下拉
      const plats = Array.from(new Set(all.map(x=>x.platform).filter(Boolean))).sort();
      const sel = $('#platform');
      sel.innerHTML = '<option value="">全部平台</option>' + plats.map(p=>`<option>${esc(p)}</option>`).join('');
      selection.clear();
      applyFilter();
    }
  </script>
</body>
</html>
